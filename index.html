<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./styles/reset.css" />
    <link rel="stylesheet" href="./styles/style.css" />
    <title>Scanner reader</title>
    <!-- <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script> -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  </head>

  <body>
    <div class="app">
      <div id="reader"></div>
      <div id="ratio">
        <div id="camera-in-use"></div>
        <div id="count_id">Count:</div>
      </div>
    </div>
  </body>

  <script>
    let scannedProducts = new Set();
    let count = 0;

    const config = {
      fps: 60,
      // qrbox: { width: 320, height: 240 },
      qrbox: { width: 320, height: 280 },
      // aspectRatio: window.innerWidth / window.innerHeight,
      aspectRatio: window.innerHeight / window.innerWidth,
      formatsToSupport: [Html5QrcodeSupportedFormats.DATA_MATRIX],
    };

    const html5Qrcode = new Html5Qrcode("reader");

    function onScanSuccess(text, result) {
      count++;

      if (
        !scannedProducts.has(result) &&
        result.format.formatName === "DATA_MATRIX"
      ) {
        scannedProducts.add(result);
        console.log("Добавлен:", result);
        document.getElementById("count_id").textContent = `Count: ${count}`;
      } else {
        console.log("Дубликат, не добавляем:", result);
      }

      console.log("Count:", count);
      console.log("Scanned:", text);
      console.log("Всего уникальных:", scannedProducts.size);
      console.log("Set:", scannedProducts);
    }

    function onScanError(err) {
      console.warn("ERROR:", err);
    }

    Html5Qrcode.getCameras().then((cameras) => {
      if (!cameras.length) {
        console.error("No cameras found");
        return;
      }

      let backCamera =
        cameras.find((camera) => /back|rear|environment/i.test(camera.label)) ||
        cameras.find((camera) => /wide|ultra|tele/i.test(camera.label));

      const cameraId = backCamera ? backCamera.id : cameras[0].id;

      console.log("Using camera:", backCamera?.label || "default");

      document.getElementById("camera-in-use").textContent =
        `Camera: ${backCamera?.label || "default"}`;

      html5Qrcode.start(
        { deviceId: cameraId },
        config,
        onScanSuccess,
        onScanError,
      );
    });
  </script>
</html>
